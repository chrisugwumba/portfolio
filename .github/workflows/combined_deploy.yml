name: Deploy Main and Draft

on:
  push:
    branches: [main, draft]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # environment:
    # name: github-pages
    # url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # -----------------------------
      # Checkout repositories
      # -----------------------------
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: recursive
          token: ${{ secrets.CHPAT }}
          fetch-depth: 0
          path: prod_site

      - name: Checkout Draft
        uses: actions/checkout@v4
        with:
          ref: draft
          submodules: recursive
          token: ${{ secrets.CHPAT }}
          fetch-depth: 0
          path: staging_site
          clean: false

      # -----------------------------
      # Install Hugo
      # -----------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "latest"
          extended: true

      # -----------------------------
      # Build Production Site
      # Output → prod_site/docs/blog
      # -----------------------------
      - name: Build Main Site
        working-directory: prod_site/blogs
        run: |
          hugo --baseURL="https://kaustuvbot.github.io/blog/"

      # -----------------------------
      # Build Draft Site
      # Output → staging_site/docs/blog
      # -----------------------------
      - name: Build Draft Site
        working-directory: staging_site/blogs
        run: |
          hugo \
            --baseURL="https://kaustuvbot.github.io/draft/blog/" \
            --buildDrafts \
            --buildFuture

      # -----------------------------
      # Merge outputs for Pages
      # -----------------------------
      - name: Prepare Deployment Directory
        run: |

          mkdir -p public/blog
          mkdir -p public/draft/blog


          cp -a prod_site/. public/
          if [ -d "prod_site/docs/blog" ]; then
            cp -a prod_site/docs/blog/. public/blog/
          fi


           

          if [ -d "staging_site/blogs" ]; then
            echo "Draft branch found, deploying staging..."
            cp -a staging_site/. public/draft/
            cp -a staging_site/docs/blog/. public/draft/blog/
          else
            echo "Draft branch missing/empty, using main as fallback to prevent 404..."
            cp -a prod_site/. public/draft/
            cp -a prod_site/docs/blog/. public/draft/blog/
          fi

          rm -rf public/docs
          rm -rf public/draft/docs
          find public -name ".git*" -exec rm -rf {} + || true

      # -----------------------------
      # Upload + Deploy
      # -----------------------------
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
