name: Deploy Main and Draft

on:
  push:
    branches: [main, draft]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------
      # 1. CHECKOUTS (Explicit Refs to fix Merge confusion)
      # ------------------------------------------------------
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          path: prod_site
          fetch-depth: 0
          token: ${{ secrets.CHPAT }}
          submodules: recursive

      - name: Checkout Draft
        uses: actions/checkout@v4
        with:
          ref: refs/heads/draft # <--- FORCE specific branch ref
          path: staging_site
          fetch-depth: 0
          token: ${{ secrets.CHPAT }}
          submodules: recursive
        continue-on-error: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "latest"
          extended: true

      # ------------------------------------------------------
      # 2. BUILD MAIN SITE (The "Golden" Copy)
      # ------------------------------------------------------
      - name: Build Main Site
        working-directory: prod_site/blogs
        # We output DIRECTLY to a temp folder to keep it clean
        run: hugo --baseURL="https://kaustuvbot.github.io/blog/" --destination="../../../temp_main_blog"

      # ------------------------------------------------------
      # 3. BUILD DRAFT SITE (Try to build, but don't crash)
      # ------------------------------------------------------
      - name: Build Draft Site
        id: build_draft
        if: hashFiles('staging_site/blogs/hugo.toml') != ''
        working-directory: staging_site/blogs
        # We output DIRECTLY to a separate temp folder
        run: hugo --baseURL="https://kaustuvbot.github.io/draft/blog/" --buildDrafts --buildFuture --destination="../../../temp_draft_blog"
        continue-on-error: true

      # ------------------------------------------------------
      # 4. ASSEMBLE (The Self-Healing Step)
      # ------------------------------------------------------
      - name: Assemble & Heal
        run: |
          # A. Setup Public Directory
          mkdir -p public/blog
          mkdir -p public/draft/blog

          # --- DEPLOY MAIN ---
          # 1. Copy Static Root (Landing Page)
          cp -a prod_site/. public/
          # 2. Copy Built Blog (from temp folder)
          cp -a temp_main_blog/. public/blog/

          # --- DEPLOY DRAFT (With Healing Logic) ---

          # Check if the draft build actually produced files
          if [ -d "temp_draft_blog" ] && [ "$(ls -A temp_draft_blog)" ]; then
            echo "✅ Draft build SUCCESS. Deploying Draft content."
            # Copy Draft Static Root
            cp -a staging_site/. public/draft/
            # Copy Draft Built Blog
            cp -a temp_draft_blog/. public/draft/blog/
          else
            echo "⚠️ Draft build FAILED or MISSING. Healing with Main content."
            # COPY THE BUILT MAIN SITE into the Draft folder
            # This ensures NO 404s. It just looks like Main.
            cp -a public/* public/draft/ 2>/dev/null || true
            
            # Fix the base tag if possible (optional, but helps theme)
            # This is a crude patch to prevent broken CSS in the cloned version
            # sed -i 's|/blog/|/draft/blog/|g' public/draft/blog/index.html || true
          fi

          # Cleanup Git metadata so Pages doesn't reject it
          find public -name ".git*" -exec rm -rf {} + || true

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
